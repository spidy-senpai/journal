<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas Diary Editor - Enhanced</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Merriweather:wght@300;400;700&family=Roboto:wght@300;400;500;700&family=Playfair+Display:wght@400;500;600;700&family=Lora:wght@400;500;600;700&family=Montserrat:wght@300;400;500;600;700&family=Dancing+Script:wght@400;500;600;700&family=Crimson+Text:wght@400;600;700&family=Open+Sans:wght@300;400;500;600;700&family=Pacifico&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/interact.js/1.10.19/interact.min.js"></script>
    <style>
        :root {
            --bg-primary: #0d0d0d;
            --bg-secondary: #171717;
            --bg-tertiary: #262626;
            --border-color: #2a2a2a;
            --text-primary: #e5e5e5;
            --text-secondary: #a3a3a3;
            --text-tertiary: #737373;
            --accent: #ffffff;
            --danger: #dc2626;
            --success: #10b981;
            --warning: #f59e0b;
        }
        
        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-tertiary: #f3f4f6;
            --border-color: #e5e7eb;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --text-tertiary: #9ca3af;
            --accent: #000000;
        }
        
        [data-theme="sepia"] {
            --bg-primary: #f4ecd8;
            --bg-secondary: #ece2c8;
            --bg-tertiary: #e4d9bf;
            --border-color: #d4c5a9;
            --text-primary: #5c4a3a;
            --text-secondary: #8b7355;
            --text-tertiary: #a68968;
            --accent: #5c4a3a;
        }
        
        [data-theme="blue"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --border-color: #475569;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-tertiary: #94a3b8;
            --accent: #60a5fa;
        }
        
        [data-theme="green"] {
            --bg-primary: #064e3b;
            --bg-secondary: #065f46;
            --bg-tertiary: #047857;
            --border-color: #059669;
            --text-primary: #d1fae5;
            --text-secondary: #a7f3d0;
            --text-tertiary: #6ee7b7;
            --accent: #34d399;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
        }
        
        .app-container {
            display: flex;
            height: 100vh;
            position: relative;
        }
        
        .sidebar {
            width: 260px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: fixed;
            height: 100vh;
            z-index: 100;
            left: 0;
            top: 0;
        }
        
        .sidebar.collapsed {
            transform: translateX(-260px);
        }
        
        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1rem;
        }
        
        .logo-icon {
            width: 32px;
            height: 32px;
            background: var(--accent);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #000;
            font-size: 0.85rem;
        }
        
        .new-entry-btn {
            width: 100%;
            background: var(--accent);
            border: none;
            color: var(--bg-primary);
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            margin-top: 12px;
        }
        
        .new-entry-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .nav-section {
            flex: 1;
            padding: 12px 8px;
            overflow-y: auto;
        }
        
        .nav-item {
            padding: 10px 12px;
            margin: 2px 0;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-secondary);
            transition: all 0.15s ease;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .nav-item.active {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            min-width: 0;
            margin-left: 260px;
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .main-content.expanded {
            margin-left: 0;
        }
        
        .top-bar {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }
        
        .toggle-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.2s ease;
        }
        
        .toggle-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .page-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .top-bar-stats {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .stat-item:hover {
            color: var(--text-primary);
        }
        
        .stat-value {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .content-area {
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        .canvas-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: auto;
        }
        
        .editor-canvas {
            position: relative;
            min-height: 100%;
            min-width: 100%;
            background: transparent !important;
            z-index: 1;
        }
        
        .canvas-background-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
            opacity: 0.25;
            background-size: cover;
            background-position: center;
        }
        
        .entry-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
            position: relative;
            z-index: 1;
        }
        
        .title-input {
            width: 100%;
            font-size: 2rem;
            font-weight: 700;
            border: none;
            background: transparent;
            color: var(--text-primary);
            padding: 0;
            outline: none;
            margin-bottom: 8px;
        }
        
        .title-input::placeholder {
            color: #404040;
        }
        
        .meta-info {
            display: flex;
            gap: 16px;
            font-size: 0.8rem;
            color: var(--text-tertiary);
            font-weight: 500;
            flex-wrap: wrap;
        }
        
        .draggable-item {
            position: absolute;
            min-width: 100px;
            min-height: 50px;
            border: 2px solid transparent;
            transition: border-color 0.2s ease;
            z-index: 10;
        }
        
        .draggable-item.move-mode {
            cursor: move;
        }
        
        .draggable-item.edit-mode {
            cursor: auto;
        }
        
        .draggable-item:hover {
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .draggable-item.selected {
            border-color: var(--accent);
            border-style: solid;
        }
        
        .item-controls {
            position: absolute;
            top: -40px;
            right: 0;
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 10;
        }
        
        .draggable-item:hover .item-controls,
        .draggable-item.selected .item-controls {
            opacity: 1;
        }
        
        .item-control-btn {
            width: 32px;
            height: 32px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-tertiary);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }
        
        .item-control-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .item-control-btn.delete:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }
        
        .item-control-btn.active {
            background: var(--accent);
            color: var(--bg-primary);
            border-color: var(--accent);
        }
        
        .text-box {
            width: 100%;
            height: 100%;
            min-height: 60px;
            border: none;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            padding: 16px;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
            resize: none;
            outline: none;
            line-height: 1.6;
            border-radius: 8px;
            overflow: auto;
            box-shadow: 0 0 10px #0079FF8A; /* Inner glow - softer, less sp#436F74BD#55607C99read */
            0 0 25px #456B6FA3; /* Outer glow - more spread, transparent */

        }
        
        .text-box::placeholder {
            color: #606060;
        }
        
        .text-box:focus {
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .media-item {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 6px;
        }
        
        .video-item {
            width: 100%;
            height: 100%;
            border-radius: 6px;
        }
        
        .audio-item {
            width: 100%;
        }
        
        .document-item {
            width: 100%;
            height: 100%;
            padding: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .document-icon {
            width: 48px;
            height: 48px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent);
            flex-shrink: 0;
        }
        
        .document-info {
            flex: 1;
            min-width: 0;
        }
        
        .document-name {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .document-size {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin-top: 2px;
        }
        
        .sticker-item {
            width: 100%;
            height: 100%;
            object-fit: contain;
            pointer-events: none;
        }
        
        .resize-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--accent);
            border: 2px solid var(--bg-primary);
            border-radius: 50%;
            z-index: 10;
        }
        
        .resize-handle.se {
            right: -6px;
            bottom: -6px;
            cursor: se-resize;
        }
        
        .toolbar {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 90;
        }
        
        .toolbar-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .toolbar-btn:hover {
            background: var(--accent);
            color: var(--bg-primary);
            border-color: var(--accent);
        }
        
        .text-format-toolbar {
            position: fixed;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 8px;
            display: none;
            gap: 6px;
            z-index: 1000;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
            flex-wrap: wrap;
            max-width: 400px;
        }
        
        .text-format-toolbar.active {
            display: flex;
        }
        
        .format-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        .format-btn:hover {
            background: var(--accent);
            color: var(--bg-primary);
            transform: scale(1.05);
        }
        
        .format-btn.highlight {
            background: #fbbf24;
            color: #000;
        }
        
        .format-btn.highlight:hover {
            background: #f59e0b;
        }
        
        .toolbar-divider {
            width: 1px;
            height: 36px;
            background: var(--border-color);
            margin: 0 4px;
        }
        
        .color-picker-btn {
            width: 32px;
            height: 32px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .color-picker-btn input[type="color"] {
            position: absolute;
            width: 200%;
            height: 200%;
            top: -50%;
            left: -50%;
            border: none;
            cursor: pointer;
        }
        
        .recording-indicator {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(220, 38, 38, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 16px 24px;
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 95;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        
        .recording-indicator.active {
            display: flex;
        }
        
        .recording-dot {
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        
        .recording-time {
            color: white;
            font-weight: 600;
            font-size: 1rem;
            min-width: 60px;
        }
        
        .stop-recording-btn {
            padding: 8px 16px;
            background: white;
            border: none;
            color: var(--danger);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }
        
        .stop-recording-btn:hover {
            background: #f3f4f6;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.5rem;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .modal-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .font-grid {
            display: grid;
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 16px;
        }
        
        .font-option {
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .font-option:hover {
            border-color: var(--accent);
        }
        
        .font-option.active {
            border-color: var(--accent);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .sticker-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .sticker-option {
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }
        
        .sticker-option img {
            width: 100%;
            height: auto;
            max-width: 80px;
        }
        
        .sticker-option:hover {
            transform: scale(1.05);
            border-color: var(--accent);
        }
        
        .theme-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .theme-option {
            padding: 16px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }
        
        .theme-option:hover {
            border-color: var(--accent);
        }
        
        .theme-option.active {
            border-color: var(--accent);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .theme-preview {
            width: 100%;
            height: 60px;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            gap: 4px;
            padding: 8px;
        }
        
        .theme-preview-color {
            flex: 1;
            border-radius: 4px;
        }
        
        .theme-name {
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .bg-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .bg-tab {
            padding: 10px 16px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }
        
        .bg-tab.active {
            color: var(--text-primary);
            border-bottom-color: var(--accent);
        }
        
        .bg-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        
        .bg-option {
            height: 100px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid var(--border-color);
            transition: all 0.2s ease;
            background-size: cover;
            background-position: center;
            position: relative;
        }
        
        .bg-option:hover {
            border-color: var(--accent);
            transform: scale(1.05);
        }
        
        .bg-option.active {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent);
        }
        
        .color-palette {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-top: 12px;
        }
        
        .color-swatch {
            width: 100%;
            height: 40px;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid var(--border-color);
            transition: all 0.2s ease;
        }
        
        .color-swatch:hover {
            transform: scale(1.1);
            border-color: var(--accent);
        }
        
        .time-capsule-form label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .time-capsule-form input {
            width: 100%;
            padding: 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.9rem;
            margin-bottom: 16px;
        }
        
        .time-capsule-form input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .modal-btn {
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .modal-btn-primary {
            background: var(--accent);
            border: none;
            color: var(--bg-primary);
        }
        
        .modal-btn-primary:hover {
            opacity: 0.9;
        }
        
        .modal-btn-secondary {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        
        .modal-btn-secondary:hover {
            background: var(--bg-tertiary);
        }
        
        .notification {
            position: fixed;
            top: 24px;
            right: 24px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 16px 20px;
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.875rem;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            z-index: 1001;
            display: none;
        }
        
        .notification.show {
            display: block;
            animation: slideIn 0.3s ease;
        }
        
        .notification.success {
            border-color: var(--success);
        }
        
        .notification.error {
            border-color: var(--danger);
        }
        
        .file-input-wrapper {
            display: none;
        }
        
        .save-btn {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--accent);
            border: none;
            color: var(--bg-primary);
            padding: 14px 24px;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 90;
        }
        
        .save-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }
            
            50% {
                opacity: 0.5;
                transform: scale(0.95);
            }
        }
        
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #404040;
        }
        
        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
            }
            
            .toolbar {
                bottom: 12px;
                left: 12px;
                right: 12px;
                transform: none;
            }
            
            .save-btn {
                bottom: 80px;
            }
        }
        .canvas-background-overlay {
    opacity: 1 !important;
    z-index: 0 !important;
}
    </style>
</head>

<body>
    <div class="app-container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">D</div>
                    <span>Canvas Diary</span>
                </div>
                <button class="new-entry-btn" onclick="resetEditor()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14M5 12h14" />
                    </svg>
                    New Entry
                </button>
            </div>
            
            <div class="nav-section">
                <div class="nav-item active">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z" />
                    </svg>
                    <span>Canvas Editor</span>
                </div>
                <div class="nav-item">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />
                        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />
                    </svg>
                    <span>Past Entries</span>
                </div>
            </div>
        </div>
        
        <div class="main-content" id="mainContent">
            <div class="top-bar">
                <button class="toggle-btn" id="menuToggleBtn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12h18M3 6h18M3 18h18" />
                    </svg>
                </button>
                <div class="page-title">Canvas Editor</div>
                
                <div class="top-bar-stats">
                    <div class="stat-item" title="Word Count">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 7V4h16v3M9 20h6M12 4v16" />
                        </svg>
                        <span class="stat-value" id="wordCount">0</span>
                        <span>words</span>
                    </div>
                    
                    <div class="stat-item" onclick="openTimeCapsule()" title="Set Time Capsule">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10" />
                            <path d="M12 6v6l4 2" />
                        </svg>
                        <span>Time Capsule</span>
                    </div>
                    
                    <div class="stat-item" onclick="openThemeSelector()" title="Change Theme">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
                        </svg>
                        <span>Theme</span>
                    </div>
                    
                    <div class="stat-item" onclick="openBackgroundSelector()" title="Background">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                            <circle cx="8.5" cy="8.5" r="1.5" />
                            <path d="m21 15-5-5L5 21" />
                        </svg>
                        <span>Background</span>
                    </div>
                </div>
            </div>
            
            <div class="content-area">
                <div class="entry-header">
                    <input type="text" class="title-input" placeholder="Untitled Entry" id="entryTitle">
                    <div class="meta-info">
                        <div id="currentDate"></div>
                        <div>Â·</div>
                        <div id="currentTime"></div>
                    </div>
                </div>
                
                <div class="canvas-container">
                    <div class="canvas-background-overlay" id="canvasBackground"></div>
                    <div class="editor-canvas" id="editorCanvas"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Text Format Toolbar -->
    <div class="text-format-toolbar" id="textFormatToolbar">
        <button class="format-btn" onclick="formatText('bold')" title="Bold (Ctrl+B)">
            <strong>B</strong>
        </button>
        <button class="format-btn" onclick="formatText('italic')" title="Italic (Ctrl+I)" style="font-style: italic;">
            I
        </button>
        <button class="format-btn" onclick="formatText('underline')" title="Underline (Ctrl+U)" style="text-decoration: underline;">
            U
        </button>
        
        <div class="toolbar-divider"></div>
        
        <button class="format-btn" onclick="changeFontSize('larger')" title="Increase Size">
            A+
        </button>
        <button class="format-btn" onclick="changeFontSize('smaller')" title="Decrease Size" style="font-size: 0.7rem;">
            A-
        </button>
        
        <div class="toolbar-divider"></div>
        
        <div class="color-picker-btn" title="Text Color">
            <input type="color" id="textColorPicker" value="#e5e5e5" onchange="applyTextColor(this.value)">
        </div>
        
        <button class="format-btn highlight" onclick="highlightText('#fbbf24')" title="Yellow Highlight">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" />
            </svg>
        </button>
        <button class="format-btn" style="background: #f87171; color: white;" onclick="highlightText('#f87171')" title="Red Highlight">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" />
            </svg>
        </button>
        <button class="format-btn" style="background: #60a5fa; color: white;" onclick="highlightText('#60a5fa')" title="Blue Highlight">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" />
            </svg>
        </button>
        <button class="format-btn" style="background: #34d399; color: white;" onclick="highlightText('#34d399')" title="Green Highlight">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" />
            </svg>
        </button>
        
        <div class="toolbar-divider"></div>
        
        <button class="format-btn" onclick="removeFormatting()" title="Remove Formatting">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18" />
                <line x1="6" y1="6" x2="18" y2="18" />
            </svg>
        </button>
    </div>
    
    <!-- Recording Indicator -->
    <div class="recording-indicator" id="recordingIndicator">
        <div class="recording-dot"></div>
        <span class="recording-time" id="recordingTime">00:00</span>
        <button class="stop-recording-btn" onclick="stopRecording()">Stop</button>
    </div>
    
    <!-- Floating Toolbar -->
    <div class="toolbar">
        <button class="toolbar-btn" onclick="addTextBox()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 7V4h16v3M9 20h6M12 4v16" />
            </svg>
            Text
        </button>
        
        <button class="toolbar-btn" onclick="openAttachmentModal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48" />
            </svg>
            Attach
        </button>
        
        <button class="toolbar-btn" onclick="openStickerModal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10" />
                <path d="M8 14s1.5 2 4 2 4-2 4-2" />
                <line x1="9" y1="9" x2="9.01" y2="9" />
                <line x1="15" y1="9" x2="15.01" y2="9" />
            </svg>
            Stickers
        </button>
    </div>
    
    <!-- Save Button -->
    <button class="save-btn" onclick="saveEntry()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; margin-right: 6px;">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
            <polyline points="17 21 17 13 7 13 7 21" />
            <polyline points="7 3 7 8 15 8" />
        </svg>
        Save Entry
    </button>
    
    <!-- File Inputs -->
    <input type="file" id="imageInput" class="file-input-wrapper" accept="image/*" multiple>
    <input type="file" id="videoInput" class="file-input-wrapper" accept="video/*">
    <input type="file" id="documentInput" class="file-input-wrapper" accept=".pdf,.doc,.docx,.txt,.xlsx,.xls">
    <input type="file" id="bgImageInput" class="file-input-wrapper" accept="image/*">
    
    <!-- Attachment Modal -->
    <div class="modal" id="attachmentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Attachment</h3>
                <button class="modal-close" onclick="closeAttachmentModal()">&times;</button>
            </div>
            <div style="display: grid; gap: 8px;">
                <button class="toolbar-btn" style="width: 100%; justify-content: flex-start;" onclick="selectImage()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                        <circle cx="8.5" cy="8.5" r="1.5" />
                        <path d="m21 15-5-5L5 21" />
                    </svg>
                    Images
                </button>
                <button class="toolbar-btn" style="width: 100%; justify-content: flex-start;" onclick="selectVideo()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="m23 7-7 5 7 5V7zM2 3h16v18H2z" />
                    </svg>
                    Video (max 100MB)
                </button>
                <button class="toolbar-btn" style="width: 100%; justify-content: flex-start;" onclick="startRecording(); closeAttachmentModal();">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" />
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2M12 19v4M8 23h8" />
                    </svg>
                    Voice Recording (max 5 min)
                </button>
                <button class="toolbar-btn" style="width: 100%; justify-content: flex-start;" onclick="selectDocument()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                        <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8" />
                    </svg>
                    Document (PDF, Word, Excel)
                </button>
            </div>
        </div>
    </div>
    
    <!-- Font Selector Modal -->
    <div class="modal" id="fontModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Choose Font</h3>
                <button class="modal-close" onclick="closeFontModal()">&times;</button>
            </div>
            <div class="font-grid" id="fontGrid"></div>
        </div>
    </div>
    
    <!-- Sticker Modal -->
    <div class="modal" id="stickerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Animated Stickers</h3>
                <button class="modal-close" onclick="closeStickerModal()">&times;</button>
            </div>
            <div class="sticker-grid">
                <div class="sticker-option" onclick="addSticker('https://media.giphy.com/media/ICOgUNjpvO0PC/giphy.gif')">
                    <img src="https://media.giphy.com/media/ICOgUNjpvO0PC/giphy.gif" alt="Cat">
                </div>
                <div class="sticker-option" onclick="addSticker('https://media.giphy.com/media/MDJ9IbxxvDUQM/giphy.gif')">
                    <img src="https://media.giphy.com/media/MDJ9IbxxvDUQM/giphy.gif" alt="Dog">
                </div>
                <div class="sticker-option" onclick="addSticker('https://media.giphy.com/media/11sBLVxNs7v6WA/giphy.gif')">
                    <img src="https://media.giphy.com/media/11sBLVxNs7v6WA/giphy.gif" alt="Heart">
                </div>
                <div class="sticker-option" onclick="addSticker('https://media.giphy.com/media/l0HlTy9x8FZo0XO1i/giphy.gif')">
                    <img src="https://media.giphy.com/media/l0HlTy9x8FZo0XO1i/giphy.gif" alt="Star">
                </div>
                <div class="sticker-option" onclick="addSticker('https://media.giphy.com/media/3oriO0OEd9QIDdllqo/giphy.gif')">
                    <img src="https://media.giphy.com/media/3oriO0OEd9QIDdllqo/giphy.gif" alt="Sparkles">
                </div>
                <div class="sticker-option" onclick="addSticker('https://media.giphy.com/media/l0MYt5jPR6QX5pnqM/giphy.gif')">
                    <img src="https://media.giphy.com/media/l0MYt5jPR6QX5pnqM/giphy.gif" alt="Fire">
                </div>
                <div class="sticker-option" onclick="addSticker('https://media.giphy.com/media/l2JhORT5IFnj6ioko/giphy.gif')">
                    <img src="https://media.giphy.com/media/l2JhORT5IFnj6ioko/giphy.gif" alt="Rainbow">
                </div>
                <div class="sticker-option" onclick="addSticker('https://media.giphy.com/media/26BRuo6sLetdllPAQ/giphy.gif')">
                    <img src="https://media.giphy.com/media/26BRuo6sLetdllPAQ/giphy.gif" alt="Thumbs">
                </div>
            </div>
        </div>
    </div>
    
    <!-- Theme Modal -->
    <div class="modal" id="themeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Choose Theme</h3>
                <button class="modal-close" onclick="closeThemeModal()">&times;</button>
            </div>
            <div class="theme-grid">
                <div class="theme-option active" data-theme="dark" onclick="changeTheme('dark')">
                    <div class="theme-preview" style="background: #171717;">
                        <div class="theme-preview-color" style="background: #0d0d0d;"></div>
                        <div class="theme-preview-color" style="background: #262626;"></div>
                        <div class="theme-preview-color" style="background: #e5e5e5;"></div>
                    </div>
                    <div class="theme-name">Dark</div>
                </div>
                <div class="theme-option" data-theme="light" onclick="changeTheme('light')">
                    <div class="theme-preview" style="background: #f9fafb;">
                        <div class="theme-preview-color" style="background: #ffffff;"></div>
                        <div class="theme-preview-color" style="background: #f3f4f6;"></div>
                        <div class="theme-preview-color" style="background: #111827;"></div>
                    </div>
                    <div class="theme-name">Light</div>
                </div>
                <div class="theme-option" data-theme="sepia" onclick="changeTheme('sepia')">
                    <div class="theme-preview" style="background: #ece2c8;">
                        <div class="theme-preview-color" style="background: #f4ecd8;"></div>
                        <div class="theme-preview-color" style="background: #e4d9bf;"></div>
                        <div class="theme-preview-color" style="background: #5c4a3a;"></div>
                    </div>
                    <div class="theme-name">Sepia</div>
                </div>
                <div class="theme-option" data-theme="blue" onclick="changeTheme('blue')">
                    <div class="theme-preview" style="background: #1e293b;">
                        <div class="theme-preview-color" style="background: #0f172a;"></div>
                        <div class="theme-preview-color" style="background: #334155;"></div>
                        <div class="theme-preview-color" style="background: #60a5fa;"></div>
                    </div>
                    <div class="theme-name">Ocean Blue</div>
                </div>
                <div class="theme-option" data-theme="green" onclick="changeTheme('green')">
                    <div class="theme-preview" style="background: #065f46;">
                        <div class="theme-preview-color" style="background: #064e3b;"></div>
                        <div class="theme-preview-color" style="background: #047857;"></div>
                        <div class="theme-preview-color" style="background: #34d399;"></div>
                    </div>
                    <div class="theme-name">Forest Green</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Background Modal -->
    <div class="modal" id="backgroundModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Canvas Background</h3>
                <button class="modal-close" onclick="closeBackgroundModal()">&times;</button>
            </div>
            
            <div class="bg-tabs">
                <button class="bg-tab active" onclick="switchBgTab('colors')">Colors</button>
                <button class="bg-tab" onclick="switchBgTab('gradients')">Gradients</button>
                <button class="bg-tab" onclick="switchBgTab('patterns')">Patterns</button>
                <button class="bg-tab" onclick="switchBgTab('upload')">Upload</button>
            </div>
            
            <div id="bgColorsTab" class="bg-tab-content">
                <div class="color-palette" id="colorPalette"></div>
                <div style="margin-top: 16px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 0.875rem;">Custom Color</label>
                    <input type="color" id="customBgColor" style="width: 100%; height: 50px; border-radius: 8px; cursor: pointer;" onchange="setCanvasBg('color', this.value)">
                </div>
            </div>
            
            <div id="bgGradientsTab" class="bg-tab-content" style="display: none;">
                <div class="bg-grid" id="gradientGrid"></div>
            </div>
            
            <div id="bgPatternsTab" class="bg-tab-content" style="display: none;">
                <div class="bg-grid" id="patternGrid"></div>
            </div>
            
            <div id="bgUploadTab" class="bg-tab-content" style="display: none;">
                <div style="border: 2px dashed var(--border-color); border-radius: 8px; padding: 32px; text-align: center; cursor: pointer;" onclick="document.getElementById('bgImageInput').click()">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin: 0 auto; color: var(--text-secondary);">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="17 8 12 3 7 8" />
                        <line x1="12" y1="3" x2="12" y2="15" />
                    </svg>
                    <p style="color: var(--text-secondary); margin-top: 12px;">Click to upload image</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Text Box Background Modal -->
    <div class="modal" id="textBoxBgModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Text Box Background</h3>
                <button class="modal-close" onclick="closeTextBoxBgModal()">&times;</button>
            </div>
            
            <div class="color-palette" id="textBoxColorPalette"></div>
            <div style="margin-top: 16px;">
                <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 0.875rem;">Custom Color</label>
                <input type="color" id="customTextBoxBg" style="width: 100%; height: 50px; border-radius: 8px; cursor: pointer;" onchange="setTextBoxBg(this.value)">
            </div>
            <button class="modal-btn modal-btn-secondary" style="width: 100%; margin-top: 16px;" onclick="setTextBoxBg('transparent')">Remove Background</button>
        </div>
    </div>
    
    <!-- Time Capsule Modal -->
    <div class="modal" id="timeCapsuleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Set Time Capsule</h3>
                <button class="modal-close" onclick="closeTimeCapsuleModal()">&times;</button>
            </div>
            <form class="time-capsule-form">
                <label for="capsuleDate">Open this entry on:</label>
                <input type="date" id="capsuleDate" required>
                <p style="font-size: 0.875rem; color: var(--text-tertiary);">
                    You'll receive a reminder to revisit this entry on the selected date.
                </p>
            </form>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeTimeCapsuleModal()">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="saveTimeCapsule()">Save</button>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>
    <div class="resize-handle se"></div>
    <script>
        // Global variables
        let canvasItems = [];
        let itemCounter = 0;
        let selectedItem = null;
        let currentTheme = 'dark';
        let currentSelectedTextBox = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let recordingInterval = null;
        let recordingSeconds = 0;
        let timeCapsuleDate = null;
        
        const fonts = [
            'Inter', 'Merriweather', 'Roboto', 'Playfair Display',
            'Lora', 'Montserrat', 'Dancing Script', 'Crimson Text',
            'Open Sans', 'Pacifico'
        ];
        
        const colors = [
            '#ffffff', '#000000', '#ef4444', '#f59e0b', '#10b981',
            '#3b82f6', '#8b5cf6', '#ec4899', '#f97316', '#14b8a6',
            '#6366f1', '#a855f7'
        ];
        
        const gradients = [
            'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
            'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
            'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
            'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
            'linear-gradient(135deg, #30cfd0 0%, #330867 100%)'
        ];
        
        const patterns = [
            'repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,.05) 10px, rgba(255,255,255,.05) 20px)',
            'radial-gradient(circle, rgba(255,255,255,.1) 1px, transparent 1px)',
            'repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255,255,255,.03) 2px, rgba(255,255,255,.03) 4px)',
            'linear-gradient(45deg, rgba(255,255,255,.03) 25%, transparent 25%, transparent 75%, rgba(255,255,255,.03) 75%)'
        ];
        
        function init() {
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            addTextBox();
            initFontGrid();
            initColorPalette();
            initGradients();
            initPatterns();
            
            document.getElementById('imageInput').addEventListener('change', handleImageUpload);
            document.getElementById('videoInput').addEventListener('change', handleVideoUpload);
            document.getElementById('documentInput').addEventListener('change', handleDocumentUpload);
            document.getElementById('bgImageInput').addEventListener('change', handleBgImageUpload);
            
            document.getElementById('entryTitle').addEventListener('input', updateWordCount);
            
            document.addEventListener('mouseup', handleTextSelection);
            document.addEventListener('mousedown', (e) => {
                if (!e.target.closest('.text-format-toolbar')) {
                    document.getElementById('textFormatToolbar').classList.remove('active');
                }
            });
            
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    closeAllModals();
                }
            });
            
            document.getElementById('editorCanvas').addEventListener('click', (e) => {
                if (e.target.id === 'editorCanvas') {
                    deselectAll();
                }
            });
            
            // Set minimum date for time capsule
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('capsuleDate').min = today;
        }
        
        function initFontGrid() {
            const grid = document.getElementById('fontGrid');
            fonts.forEach(font => {
                const option = document.createElement('div');
                option.className = 'font-option';
                option.style.fontFamily = font;
                option.textContent = font;
                option.onclick = () => applyFontToSelected(font);
                grid.appendChild(option);
            });
        }
        
        function initColorPalette() {
            const palette = document.getElementById('colorPalette');
            const textBoxPalette = document.getElementById('textBoxColorPalette');
            
            colors.forEach(color => {
                const swatch = document.createElement('div');
                swatch.className = 'color-swatch';
                swatch.style.background = color;
                swatch.onclick = () => setCanvasBg('color', color);
                palette.appendChild(swatch);
                
                const textSwatch = document.createElement('div');
                textSwatch.className = 'color-swatch';
                textSwatch.style.background = color;
                textSwatch.onclick = () => setTextBoxBg(color);
                textBoxPalette.appendChild(textSwatch);
            });
        }
        
        function initGradients() {
            const grid = document.getElementById('gradientGrid');
            gradients.forEach((gradient, i) => {
                const option = document.createElement('div');
                option.className = 'bg-option';
                option.style.background = gradient;
                option.onclick = () => setCanvasBg('gradient', gradient);
                grid.appendChild(option);
            });
        }
        
        function initPatterns() {
            const grid = document.getElementById('patternGrid');
            patterns.forEach((pattern, i) => {
                const option = document.createElement('div');
                option.className = 'bg-option';
                option.style.background = `var(--bg-tertiary) ${pattern}`;
                option.style.backgroundSize = '20px 20px';
                option.onclick = () => setCanvasBg('pattern', pattern);
                grid.appendChild(option);
            });
        }
        
        function updateDateTime() {
            const now = new Date();
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function updateWordCount() {
            let totalWords = 0;
            const title = document.getElementById('entryTitle').value;
            totalWords += title.trim().split(/\s+/).filter(word => word.length > 0).length;
            
            canvasItems.forEach(item => {
                if (item.type === 'text') {
                    const textBox = document.querySelector(`[data-item-id="${item.id}"] .text-box`);
                    if (textBox) {
                        const text = textBox.value || textBox.innerText || '';
                        totalWords += text.trim().split(/\s+/).filter(word => word.length > 0).length;
                    }
                }
            });
            
            document.getElementById('wordCount').textContent = totalWords;
        }
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');
        }
        
        function showNotification(message, type = 'success') {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.className = `notification ${type} show`;
            setTimeout(() => notif.classList.remove('show'), 3000);
        }
        
        function resetEditor() {
            document.getElementById('entryTitle').value = '';
            canvasItems = [];
            itemCounter = 0;
            document.getElementById('editorCanvas').innerHTML = '';
            timeCapsuleDate = null;
            addTextBox();
            updateWordCount();
            showNotification('New entry started');
        }
        
        function addTextBox() {
            const id = itemCounter++;
            const item = {
                id: id,
                type: 'text',
                x: 50 + (id * 20),
                y: 50 + (id * 20),
                width: 300,
                height: 150,
                content: '',
                font: 'Inter',
                fontSize: 16,
                fontColor: '#e5e5e5',
                backgroundColor: 'rgba(255,255,255,0.02)'
            };
            canvasItems.push(item);
            renderItem(item);
            showNotification('Text box added');
        }
        
        function addImage(file, url) {
            const id = itemCounter++;
            const item = {
                id: id,
                type: 'image',
                x: 100 + (id * 20),
                y: 100 + (id * 20),
                width: 300,
                height: 200,
                url: url,
                file: file,
                fileName: file.name,
                fileSize: file.size
            };
            canvasItems.push(item);
            renderItem(item);
        }
        
        function addVideo(file, url) {
            const id = itemCounter++;
            const item = {
                id: id,
                type: 'video',
                x: 100 + (id * 20),
                y: 100 + (id * 20),
                width: 400,
                height: 300,
                url: url,
                file: file,
                fileName: file.name,
                fileSize: file.size
            };
            canvasItems.push(item);
            renderItem(item);
        }
        
        function addDocument(file) {
            const id = itemCounter++;
            const item = {
                id: id,
                type: 'document',
                x: 100 + (id * 20),
                y: 100 + (id * 20),
                width: 250,
                height: 80,
                file: file,
                fileName: file.name,
                fileSize: file.size
            };
            canvasItems.push(item);
            renderItem(item);
        }
        
        function addVoiceNote(blob, url) {
            const id = itemCounter++;
            const item = {
                id: id,
                type: 'voice',
                x: 100 + (id * 20),
                y: 100 + (id * 20),
                width: 300,
                height: 60,
                url: url,
                file: blob,
                fileName: `voice-note-${Date.now()}.webm`,
                fileSize: blob.size
            };
            canvasItems.push(item);
            renderItem(item);
        }
        
        function addSticker(url) {
            const id = itemCounter++;
            const item = {
                id: id,
                type: 'sticker',
                x: 150 + (id * 20),
                y: 150 + (id * 20),
                width: 150,
                height: 150,
                url: url
            };
            canvasItems.push(item);
            renderItem(item);
            closeStickerModal();
            showNotification('Sticker added');
        }
        
        function renderItem(item) {
            const canvas = document.getElementById('editorCanvas');
            const itemEl = document.createElement('div');
            itemEl.className = 'draggable-item';
            itemEl.setAttribute('data-item-id', item.id);
            itemEl.style.left = item.x + 'px';
            itemEl.style.top = item.y + 'px';
            itemEl.style.width = item.width + 'px';
            itemEl.style.height = item.height + 'px';
            
            // Controls
            const controls = document.createElement('div');
            controls.className = 'item-controls';
            
            if (item.type === 'text') {
                const isMoveMode = item.moveMode || false;
                controls.innerHTML = `
                    <button class="item-control-btn ${isMoveMode ? 'active' : ''}" id="move-${item.id}" onclick="toggleMoveMode(${item.id})" title="Move Mode">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 9l-3 3 3 3M9 5l3-3 3 3M15 19l-3 3-3-3M19 9l3 3-3 3M2 12h20M12 2v20"/>
                        </svg>
                    </button>
                    <button class="item-control-btn" onclick="openTextBoxFontModal(${item.id})" title="Font">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 7V4h16v3M9 20h6M12 4v16"/>
                        </svg>
                    </button>
                    <button class="item-control-btn" onclick="openTextBoxColorModal(${item.id})" title="Text Color">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                        </svg>
                    </button>
                    <button class="item-control-btn" onclick="openTextBoxBgModal(${item.id})" title="Background">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        </svg>
                    </button>
                    <button class="item-control-btn delete" onclick="deleteItem(${item.id})">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                    </button>
                `;
            } else {
                const isMoveMode = item.moveMode || false;
                controls.innerHTML = `
                    <button class="item-control-btn ${isMoveMode ? 'active' : ''}" id="move-${item.id}" onclick="toggleMoveMode(${item.id})" title="Move Mode">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 9l-3 3 3 3M9 5l3-3 3 3M15 19l-3 3-3-3M19 9l3 3-3 3M2 12h20M12 2v20"/>
                        </svg>
                    </button>
                    <button class="item-control-btn delete" onclick="deleteItem(${item.id})">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                    </button>
                `;
            }
            itemEl.appendChild(controls);
            
            // Content
            if (item.type === 'text') {
                const textBox = document.createElement('div');
                textBox.className = 'text-box';
                textBox.contentEditable = true;
                textBox.innerHTML = item.content || '';
                textBox.style.fontFamily = item.font || 'Inter';
                textBox.style.fontSize = (item.fontSize || 16) + 'px';
                textBox.style.color = item.fontColor || '#e5e5e5';
                textBox.style.background = item.backgroundColor || 'rgba(255,255,255,0.05)';
                textBox.setAttribute('placeholder', 'Start typing...');
                
                textBox.addEventListener('input', () => {
                    item.content = textBox.innerHTML;
                    updateWordCount();
                });
                textBox.addEventListener('mouseup', handleTextSelection);
                textBox.addEventListener('focus', () => {
                    currentSelectedTextBox = item.id;
                });
                itemEl.appendChild(textBox);
                
                // Set initial mode
                updateItemMode(itemEl, item.id, item.moveMode || false);
            } else if (item.type === 'image') {
                const img = document.createElement('img');
                img.className = 'media-item';
                img.src = item.url;
                img.alt = item.fileName;
                itemEl.appendChild(img);
            } else if (item.type === 'video') {
                const video = document.createElement('video');
                video.className = 'video-item';
                video.src = item.url;
                video.controls = true;
                itemEl.appendChild(video);
            } else if (item.type === 'voice') {
                const audio = document.createElement('audio');
                audio.className = 'audio-item';
                audio.src = item.url;
                audio.controls = true;
                itemEl.appendChild(audio);
            } else if (item.type === 'document') {
                const docDiv = document.createElement('div');
                docDiv.className = 'document-item';
                docDiv.innerHTML = `
                    <div class="document-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
                        </svg>
                    </div>
                    <div class="document-info">
                        <div class="document-name">${item.fileName}</div>
                        <div class="document-size">${formatFileSize(item.fileSize)}</div>
                    </div>
                `;
                itemEl.appendChild(docDiv);
            } else if (item.type === 'sticker') {
                const img = document.createElement('img');
                img.className = 'sticker-item';
                img.src = item.url;
                img.alt = 'Sticker';
                itemEl.appendChild(img);
            }
            
            // Resize handle
            const resizeHandle = document.createElement('div');
            resizeHandle.className = 'resize-handle se';
            itemEl.appendChild(resizeHandle);
            
            canvas.appendChild(itemEl);
            
            // Make it draggable and resizable
            const interaction = interact(itemEl)
                .resizable({
                    edges: { left: false, right: true, bottom: true, top: false },
                    listeners: {
                        move: resizeMoveListener
                    },
                    modifiers: [
                        interact.modifiers.restrictSize({
                            min: { width: 100, height: 50 }
                        })
                    ]
                })
                .on('tap', function(event) {
                    selectItem(item.id);
                });
            
            // Initially, dragging is disabled for text boxes
            if (item.type === 'text' && !item.moveMode) {
                // Don't enable dragging yet
            } else {
                interaction.draggable({
                    inertia: false,
                    modifiers: [
                        interact.modifiers.restrictRect({
                            restriction: 'parent',
                            endOnly: true
                        })
                    ],
                    listeners: {
                        move: dragMoveListener
                    }
                });
            }
        }
        
        function toggleMoveMode(itemId) {
            const item = canvasItems.find(i => i.id === itemId);
            if (!item) return;
            
            item.moveMode = !item.moveMode;
            const itemEl = document.querySelector(`[data-item-id="${itemId}"]`);
            const moveBtn = document.getElementById(`move-${itemId}`);
            
            if (item.moveMode) {
                moveBtn.classList.add('active');
                // Enable dragging
                interact(itemEl).draggable({
                    inertia: false,
                    modifiers: [
                        interact.modifiers.restrictRect({
                            restriction: 'parent',
                            endOnly: true
                        })
                    ],
                    listeners: {
                        move: dragMoveListener
                    }
                });
            } else {
                moveBtn.classList.remove('active');
                // Disable dragging
                interact(itemEl).draggable(false);
            }
            
            updateItemMode(itemEl, itemId, item.moveMode);
        }
        
        function updateItemMode(itemEl, itemId, isMoveMode) {
            const textBox = itemEl.querySelector('.text-box');
            
            if (isMoveMode) {
                itemEl.classList.add('move-mode');
                itemEl.classList.remove('edit-mode');
                if (textBox) {
                    textBox.contentEditable = false;
                    textBox.style.cursor = 'move';
                }
            } else {
                itemEl.classList.remove('move-mode');
                itemEl.classList.add('edit-mode');
                if (textBox) {
                    textBox.contentEditable = true;
                    textBox.style.cursor = 'text';
                }
            }
        }
        
        function dragMoveListener(event) {
            const target = event.target;
            const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
            const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
            
            target.style.transform = `translate(${x}px, ${y}px)`;
            target.setAttribute('data-x', x);
            target.setAttribute('data-y', y);
            
            const itemId = parseInt(target.getAttribute('data-item-id'));
            const item = canvasItems.find(i => i.id === itemId);
            if (item) {
                item.x = parseFloat(target.style.left) + x;
                item.y = parseFloat(target.style.top) + y;
            }
        }
        
        function resizeMoveListener(event) {
            const target = event.target;
            let x = parseFloat(target.getAttribute('data-x')) || 0;
            let y = parseFloat(target.getAttribute('data-y')) || 0;
            
            target.style.width = event.rect.width + 'px';
            target.style.height = event.rect.height + 'px';
            
            x += event.deltaRect.left;
            y += event.deltaRect.top;
            
            target.style.transform = `translate(${x}px, ${y}px)`;
            target.setAttribute('data-x', x);
            target.setAttribute('data-y', y);
            
            const itemId = parseInt(target.getAttribute('data-item-id'));
            const item = canvasItems.find(i => i.id === itemId);
            if (item) {
                item.width = event.rect.width;
                item.height = event.rect.height;
            }
        }
        
        function selectItem(id) {
            deselectAll();
            selectedItem = id;
            const itemEl = document.querySelector(`[data-item-id="${id}"]`);
            if (itemEl) {
                itemEl.classList.add('selected');
            }
        }
        
        function deselectAll() {
            document.querySelectorAll('.draggable-item').forEach(el => {
                el.classList.remove('selected');
            });
            selectedItem = null;
        }
        
        function deleteItem(id) {
            canvasItems = canvasItems.filter(item => item.id !== id);
            const itemEl = document.querySelector(`[data-item-id="${id}"]`);
            if (itemEl) {
                itemEl.remove();
            }
            updateWordCount();
            showNotification('Item deleted');
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        // File handling
        function handleImageUpload(event) {
            const files = event.target.files;
            if (files.length > 0) {
                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        addImage(file, e.target.result);
                    };
                    reader.readAsDataURL(file);
                });
                event.target.value = '';
                closeAttachmentModal();
                showNotification(`${files.length} image(s) added`);
            }
        }
        
        function handleVideoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 100 * 1024 * 1024) {
                    showNotification('Video must be less than 100MB', 'error');
                    event.target.value = '';
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    addVideo(file, e.target.result);
                    showNotification('Video added');
                };
                reader.readAsDataURL(file);
                event.target.value = '';
                closeAttachmentModal();
            }
        }
        
        function handleDocumentUpload(event) {
            const file = event.target.files[0];
            if (file) {
                addDocument(file);
                event.target.value = '';
                closeAttachmentModal();
                showNotification('Document added');
            }
        }
        
        function handleBgImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    setCanvasBg('image', e.target.result);
                    showNotification('Background image applied');
                };
                reader.readAsDataURL(file);
                event.target.value = '';
            }
        }
        
        // Voice recording
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                recordingSeconds = 0;
                
                mediaRecorder.addEventListener('dataavailable', event => {
                    audioChunks.push(event.data);
                });
                
                mediaRecorder.addEventListener('stop', () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    addVoiceNote(audioBlob, audioUrl);
                    stream.getTracks().forEach(track => track.stop());
                    showNotification('Voice note saved');
                });
                
                mediaRecorder.start();
                document.getElementById('recordingIndicator').classList.add('active');
                
                recordingInterval = setInterval(() => {
                    recordingSeconds++;
                    if (recordingSeconds >= 300) { // 5 minutes
                        stopRecording();
                        showNotification('Maximum recording time reached', 'warning');
                        return;
                    }
                    const minutes = Math.floor(recordingSeconds / 60);
                    const seconds = recordingSeconds % 60;
                    document.getElementById('recordingTime').textContent =
                        `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                }, 1000);
                
                showNotification('Recording started');
            } catch (error) {
                showNotification('Could not access microphone', 'error');
                console.error('Recording error:', error);
            }
        }
        
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                clearInterval(recordingInterval);
                document.getElementById('recordingIndicator').classList.remove('active');
                recordingSeconds = 0;
            }
        }
        
        // Text formatting
        function handleTextSelection() {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            
            if (selectedText.length > 0) {
                const range = selection.getRangeAt(0);
                const rect = range.getBoundingClientRect();
                
                const toolbar = document.getElementById('textFormatToolbar');
                toolbar.style.left = rect.left + (rect.width / 2) - 150 + 'px';
                toolbar.style.top = rect.top - 45 + window.scrollY + 'px';
                toolbar.classList.add('active');
            }
        }
        
        function formatText(command) {
            document.execCommand(command, false, null);
            showNotification(`Text ${command} applied`);
        }
        
        function applyTextColor(color) {
            document.execCommand('foreColor', false, color);
            showNotification('Text color applied');
        }
        
        function highlightText(color) {
            document.execCommand('backColor', false, color);
            showNotification('Text highlighted');
        }
        
        function removeFormatting() {
            document.execCommand('removeFormat', false, null);
            showNotification('Formatting removed');
        }
        
        function changeFontSize(direction) {
            if (direction === 'larger') {
                document.execCommand('fontSize', false, '5');
            } else {
                document.execCommand('fontSize', false, '3');
            }
            showNotification(`Font size ${direction === 'larger' ? 'increased' : 'decreased'}`);
        }
        
        function applyFontToSelected(font) {
            if (currentSelectedTextBox !== null) {
                const item = canvasItems.find(i => i.id === currentSelectedTextBox);
                if (item && item.type === 'text') {
                    item.font = font;
                    const textBox = document.querySelector(`[data-item-id="${currentSelectedTextBox}"] .text-box`);
                    if (textBox) {
                        textBox.style.fontFamily = font;
                        showNotification(`Font changed to ${font}`);
                    }
                }
            }
            closeFontModal();
        }
        
        function setTextBoxBg(color) {
            if (currentSelectedTextBox !== null) {
                const item = canvasItems.find(i => i.id === currentSelectedTextBox);
                if (item && item.type === 'text') {
                    item.backgroundColor = color === 'transparent' ? 'transparent' : color;
                    const textBox = document.querySelector(`[data-item-id="${currentSelectedTextBox}"] .text-box`);
                    if (textBox) {
                        textBox.style.background = item.backgroundColor;
                        showNotification('Text box background changed');
                    }
                }
            }
            closeTextBoxBgModal();
        }
        
     function setCanvasBg(type, value) {
    const bgOverlay = document.getElementById('canvasBackground');
    if (!bgOverlay) return;

    switch (type) {
        case 'color':
            bgOverlay.style.background = value;
            bgOverlay.style.backgroundImage = 'none';
            bgOverlay.style.opacity = '1';
            break;

        case 'gradient':
            bgOverlay.style.background = value;
            bgOverlay.style.backgroundImage = value;
            bgOverlay.style.opacity = '1';
            break;

        case 'pattern':
            bgOverlay.style.background = value;
            bgOverlay.style.backgroundSize = '20px 20px';
            bgOverlay.style.opacity = '0.6';
            break;

        case 'image':
            bgOverlay.style.backgroundImage = `url('${value}')`;
            bgOverlay.style.backgroundSize = 'cover';
            bgOverlay.style.backgroundPosition = 'center';
            bgOverlay.style.opacity = '1';
            break;
    }

    showNotification('Background updated');
    closeBackgroundModal();
}
        
        // Modal functions
        function openAttachmentModal() {
            document.getElementById('attachmentModal').classList.add('active');
        }
        
        function closeAttachmentModal() {
            document.getElementById('attachmentModal').classList.remove('active');
        }
        
        function selectImage() {
            document.getElementById('imageInput').click();
        }
        
        function selectVideo() {
            document.getElementById('videoInput').click();
        }
        
        function selectDocument() {
            document.getElementById('documentInput').click();
        }
        
        function openFontSelector() {
            document.getElementById('fontModal').classList.add('active');
        }
        
        function closeFontModal() {
            document.getElementById('fontModal').classList.remove('active');
        }
        
        function openStickerModal() {
            document.getElementById('stickerModal').classList.add('active');
        }
        
        function closeStickerModal() {
            document.getElementById('stickerModal').classList.remove('active');
        }
        
        function openThemeSelector() {
            document.getElementById('themeModal').classList.add('active');
            document.querySelectorAll('.theme-option').forEach(opt => {
                opt.classList.remove('active');
                if (opt.dataset.theme === currentTheme) {
                    opt.classList.add('active');
                }
            });
        }
        
        function closeThemeModal() {
            document.getElementById('themeModal').classList.remove('active');
        }
        
        function changeTheme(theme) {
            currentTheme = theme;
            document.documentElement.setAttribute('data-theme', theme);
            document.querySelectorAll('.theme-option').forEach(opt => {
                opt.classList.remove('active');
                if (opt.dataset.theme === theme) {
                    opt.classList.add('active');
                }
            });
            showNotification(`Theme changed to ${theme}`);
        }
        
        function openBackgroundSelector() {
            document.getElementById('backgroundModal').classList.add('active');
        }
        
        function closeBackgroundModal() {
            document.getElementById('backgroundModal').classList.remove('active');
        }
        
        function switchBgTab(tab) {
            document.querySelectorAll('.bg-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.bg-tab-content').forEach(c => c.style.display = 'none');
            
            const tabs = ['colors', 'gradients', 'patterns', 'upload'];
            const index = tabs.indexOf(tab);
            document.querySelectorAll('.bg-tab')[index].classList.add('active');
            document.getElementById(`bg${tab.charAt(0).toUpperCase() + tab.slice(1)}Tab`).style.display = 'block';
        }
        
        function openTextBoxBgModal(itemId) {
            currentSelectedTextBox = itemId;
            document.getElementById('textBoxBgModal').classList.add('active');
        }
        
        function closeTextBoxBgModal() {
            document.getElementById('textBoxBgModal').classList.remove('active');
        }
        
        function openTimeCapsule() {
            document.getElementById('timeCapsuleModal').classList.add('active');
            if (timeCapsuleDate) {
                document.getElementById('capsuleDate').value = timeCapsuleDate;
            }
        }
        
        function closeTimeCapsuleModal() {
            document.getElementById('timeCapsuleModal').classList.remove('active');
        }
        
        function saveTimeCapsule() {
            const date = document.getElementById('capsuleDate').value;
            if (date) {
                timeCapsuleDate = date;
                const formattedDate = new Date(date).toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
                showNotification(`Time capsule set for ${formattedDate}`);
                closeTimeCapsuleModal();
            } else {
                showNotification('Please select a date', 'error');
            }
        }
        
        function closeAllModals() {
            closeAttachmentModal();
            closeFontModal();
            closeStickerModal();
            closeThemeModal();
            closeBackgroundModal();
            closeTextBoxBgModal();
            closeTimeCapsuleModal();
        }
        
        // Save entry
        async function saveEntry() {
            const title = document.getElementById('entryTitle').value.trim();
            
            if (!title && canvasItems.length === 0) {
                showNotification('Please add a title or content', 'error');
                return;
            }
            
            try {
                // Prepare entry data with absolute positions
                const entryData = {
                    title: title,
                    date: new Date().toISOString(),
                    theme: currentTheme,
                    timeCapsule: timeCapsuleDate,
                    canvasBackground: document.getElementById('canvasBackground').style.background,
                    items: []
                };
                
                // Prepare FormData for file uploads
                const formData = new FormData();
                formData.append('entry_metadata', JSON.stringify({
                    title: entryData.title,
                    date: entryData.date,
                    theme: entryData.theme,
                    timeCapsule: entryData.timeCapsule,
                    canvasBackground: entryData.canvasBackground
                }));
                
                // Process each item
                canvasItems.forEach((item, index) => {
                    const itemEl = document.querySelector(`[data-item-id="${item.id}"]`);
                    const x = parseFloat(itemEl.getAttribute('data-x')) || 0;
                    const y = parseFloat(itemEl.getAttribute('data-y')) || 0;
                    
                    const itemData = {
                        id: item.id,
                        type: item.type,
                        x: parseFloat(itemEl.style.left) + x,
                        y: parseFloat(itemEl.style.top) + y,
                        width: parseFloat(itemEl.style.width),
                        height: parseFloat(itemEl.style.height)
                    };
                    
                    if (item.type === 'text') {
                        itemData.content = item.content;
                        itemData.font = item.font;
                        itemData.fontSize = item.fontSize;
                        itemData.fontColor = item.fontColor;
                        itemData.backgroundColor = item.backgroundColor;
                    } else if (item.type === 'image' || item.type === 'video' || item.type === 'voice' || item.type === 'document') {
                        itemData.fileName = item.fileName;
                        itemData.fileSize = item.fileSize;
                        itemData.fileType = item.type;
                        
                        // Add file to FormData
                        if (item.file) {
                            formData.append(`file_${index}`, item.file, item.fileName);
                        }
                    } else if (item.type === 'sticker') {
                        itemData.url = item.url;
                    }
                    
                    entryData.items.push(itemData);
                });
                
                formData.append('items_data', JSON.stringify(entryData.items));
                
                // Send to backend
                console.log('Sending entry data to backend:', entryData);
                
                // Uncomment when backend is ready:
                // const response = await fetch('/api/save-entry', {
                //     method: 'POST',
                //     body: formData
                // });
                //
                // if (response.ok) {
                //     const result = await response.json();
                //     console.log('Entry saved successfully:', result);
                //     showNotification('Entry saved successfully!', 'success');
                //     setTimeout(() => resetEditor(), 1500);
                // } else {
                //     throw new Error('Failed to save entry');
                // }
                
                // For now, just show success
                showNotification('Entry saved successfully!', 'success');
                console.log('FormData prepared for backend:', {
                    metadata: entryData,
                    totalFiles: canvasItems.filter(i => i.file).length
                });
                
            } catch (error) {
                console.error('Error saving entry:', error);
                showNotification('Failed to save entry', 'error');
            }
        }
        
        window.addEventListener('DOMContentLoaded', init);
        // Enable resizing for all draggable items
        interact('.draggable-item').resizable({
            edges: { top: true, left: true, bottom: true, right: true },
            listeners: {
                move(event) {
                    const target = event.target;
                    const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.deltaRect.left;
                    const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.deltaRect.top;
                    
                    target.style.width = event.rect.width + 'px';
                    target.style.height = event.rect.height + 'px';
                    target.style.transform = `translate(${x}px, ${y}px)`;
                    
                    target.setAttribute('data-x', x);
                    target.setAttribute('data-y', y);
                }
            },
            modifiers: [
                interact.modifiers.restrictSize({
                    min: { width: 100, height: 50 }
                })
            ],
            inertia: true
        });
        // --- Enable long-press (touch) or double-click (desktop) to move boxes ---
document.addEventListener('DOMContentLoaded', () => {
  const LONG_PRESS_DURATION = 600; // ms to trigger move mode
  let touchTimer = null;

  // Touch hold to move
  document.addEventListener('touchstart', (e) => {
    const item = e.target.closest('.draggable-item');
    if (!item) return;

    // Detect if touch is near center
    const rect = item.getBoundingClientRect();
    const touch = e.touches[0];
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;
    const dx = Math.abs(touch.clientX - centerX);
    const dy = Math.abs(touch.clientY - centerY);

    // Only trigger if within center zone
    if (dx < rect.width * 0.25 && dy < rect.height * 0.25) {
      touchTimer = setTimeout(() => {
        toggleMoveMode(parseInt(item.dataset.itemId));
      }, LONG_PRESS_DURATION);
    }
  });

  document.addEventListener('touchend', () => {
    clearTimeout(touchTimer);
  });

  // Double-click on desktop/laptop to toggle move mode
  document.addEventListener('dblclick', (e) => {
    const item = e.target.closest('.draggable-item');
    if (item) {
      toggleMoveMode(parseInt(item.dataset.itemId));
    }
  });
});
// --- Enable long-press (touch) or double-click (desktop) to move boxes ---
document.addEventListener('DOMContentLoaded', () => {
  const LONG_PRESS_DURATION = 600; // ms to trigger move mode
  let touchTimer = null;

  // Touch hold to move
  document.addEventListener('touchstart', (e) => {
    const item = e.target.closest('.draggable-item');
    if (!item) return;

    // Detect if touch is near center
    const rect = item.getBoundingClientRect();
    const touch = e.touches[0];
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;
    const dx = Math.abs(touch.clientX - centerX);
    const dy = Math.abs(touch.clientY - centerY);

    // Only trigger if within center zone
    if (dx < rect.width * 0.25 && dy < rect.height * 0.25) {
      touchTimer = setTimeout(() => {
        toggleMoveMode(parseInt(item.dataset.itemId));
      }, LONG_PRESS_DURATION);
    }
  });

  document.addEventListener('touchend', () => {
    clearTimeout(touchTimer);
  });

  // Double-click on desktop/laptop to toggle move mode
  document.addEventListener('dblclick', (e) => {
    const item = e.target.closest('.draggable-item');
    if (item) {
      toggleMoveMode(parseInt(item.dataset.itemId));
    }
  });
});
// --- Sidebar toggle for both click & touch ---
document.addEventListener('DOMContentLoaded', () => {
  const menuBtn = document.getElementById('menuToggleBtn');
  const sidebar = document.getElementById('sidebar');
  const mainContent = document.getElementById('mainContent');

  let touchStartX = 0;

  // Click or tap on the menu icon
  menuBtn.addEventListener('click', () => {
    toggleSidebar();
  });

  // Swipe gesture from left edge to open sidebar (optional bonus)
  document.addEventListener('touchstart', (e) => {
    touchStartX = e.touches[0].clientX;
  });

  document.addEventListener('touchend', (e) => {
    const touchEndX = e.changedTouches[0].clientX;
    if (touchStartX < 30 && touchEndX - touchStartX > 80 && sidebar.classList.contains('collapsed')) {
      sidebar.classList.remove('collapsed');
      mainContent.classList.remove('expanded');
    }
  });
});
// --- Sidebar auto-close when tapping outside ---
document.addEventListener('DOMContentLoaded', () => {
  const sidebar = document.getElementById('sidebar');
  const mainContent = document.getElementById('mainContent');

  document.addEventListener('click', (e) => {
    // If sidebar is open and click is outside both sidebar and toggle button
    if (
      !sidebar.classList.contains('collapsed') &&
      !e.target.closest('#sidebar') &&
      !e.target.closest('#menuToggleBtn')
    ) {
      sidebar.classList.add('collapsed');
      mainContent.classList.add('expanded');
    }
  });

  // Also close sidebar on touch outside (for mobile)
  document.addEventListener('touchstart', (e) => {
    if (
      !sidebar.classList.contains('collapsed') &&
      !e.target.closest('#sidebar') &&
      !e.target.closest('#menuToggleBtn')
    ) {
      sidebar.classList.add('collapsed');
      mainContent.classList.add('expanded');
    }
  });
});
    </script>
    <script>
async function sendCanvasToFlask() {
    const title = document.getElementById("entryTitle")?.value || "Untitled Entry";
    const timestamp = new Date().toISOString();
    const canvas = document.getElementById("editorCanvas");

    const elements = [];

    canvas.querySelectorAll(".draggable-item").forEach(el => {
        const rect = el.getBoundingClientRect();
        const parentRect = canvas.getBoundingClientRect();
        const type = el.dataset.type || "generic";
        const style = window.getComputedStyle(el);

        const elementData = {
            type,
            x: rect.left - parentRect.left,
            y: rect.top - parentRect.top,
            width: el.offsetWidth,
            height: el.offsetHeight
        };

        // Text areas
        if (el.querySelector("textarea")) {
            const textArea = el.querySelector("textarea");
            const textStyle = window.getComputedStyle(textArea);
            elementData.content = textArea.value;
            elementData.fontFamily = textStyle.fontFamily;
            elementData.fontSize = textStyle.fontSize;
            elementData.color = textStyle.color;
            elementData.background = textStyle.backgroundColor;
        }

        // Images / stickers
        else if (el.querySelector("img")) {
            const img = el.querySelector("img");
            elementData.src = img.src;
        }

        // Emojis or text-only items
        else if (el.textContent.trim() && !el.querySelector("*")) {
            elementData.content = el.textContent.trim();
            elementData.fontFamily = style.fontFamily;
            elementData.fontSize = style.fontSize;
            elementData.color = style.color;
        }

        elements.push(elementData);
    });

    const payload = { title, timestamp, elements };

    try {
        const response = await fetch("http://127.0.0.1:5000/save_canvas", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            showNotification("Canvas saved successfully!", "success");
            console.log(await response.json());
        } else {
            showNotification("Failed to save canvas.", "error");
        }
    } catch (err) {
        console.error(err);
        showNotification("Error connecting to Flask server.", "error");
    }
}

function showNotification(message, type = "success") {
    const note = document.createElement("div");
    note.className = `notification ${type} show`;
    note.textContent = message;
    document.body.appendChild(note);
    setTimeout(() => note.remove(), 3000);
}

// Bind to the Save button
document.querySelector(".save-btn")?.addEventListener("click", sendCanvasToFlask);
</script>
</body>

</html>